databaseChangeLog:
  - changeSet:
      id: 1
      author: dungeon-solver
      changes:
        - createTable:
            tableName: dungeon
            columns:
              - column:
                  name: id
                  type: uuid
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: hash_input
                  type: varchar(64)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: rows
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: cols
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false

        - createTable:
            tableName: cells
            columns:
              - column:
                  name: cell_id
                  type: uuid
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: dungeon_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: row_index
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: col_index
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: value
                  type: integer
                  constraints:
                    nullable: false

        - createTable:
            tableName: solution_paths
            columns:
              - column:
                  name: dungeon_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: cell_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: position
                  type: integer
                  constraints:
                    nullable: false
              - column:
                  name: min_hp
                  type: integer
                  constraints:
                    nullable: false

        # Foreign key constraints
        - addForeignKeyConstraint:
            baseTableName: cells
            baseColumnNames: dungeon_id
            constraintName: fk_cells_dungeon
            referencedTableName: dungeon
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: solution_paths
            baseColumnNames: dungeon_id
            constraintName: fk_solution_paths_dungeon
            referencedTableName: dungeon
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: solution_paths
            baseColumnNames: cell_id
            constraintName: fk_solution_paths_cell
            referencedTableName: cells
            referencedColumnNames: cell_id
            onDelete: CASCADE

        # Indexes for performance
        - createIndex:
            indexName: idx_dungeon_hash_input
            tableName: dungeon
            columns:
              - column:
                  name: hash_input
            unique: true

        - createIndex:
            indexName: idx_cells_dungeon_id
            tableName: cells
            columns:
              - column:
                  name: dungeon_id

        - createIndex:
            indexName: idx_cells_position
            tableName: cells
            columns:
              - column:
                  name: dungeon_id
              - column:
                  name: row_index
              - column:
                  name: col_index
            unique: true

        - createIndex:
            indexName: idx_solution_paths_dungeon
            tableName: solution_paths
            columns:
              - column:
                  name: dungeon_id
              - column:
                  name: position
